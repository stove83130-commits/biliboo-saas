import { createClient } from '@/lib/supabase/server'
import { createClient as createAdminClient } from '@supabase/supabase-js'
import { NextResponse } from 'next/server'

export const dynamic = 'force-dynamic'

export async function DELETE(request: Request) {
  try {
    const supabase = createClient()
    const { data: { user }, error: authError } = await supabase.auth.getUser()

    if (authError || !user) {
      return NextResponse.json({ error: 'Non authentifi√©' }, { status: 401 })
    }

    const userId = user.id

    console.log(`üóëÔ∏è D√©but de la suppression du compte pour l'utilisateur ${userId}`)

    // 1. Supprimer toutes les factures de l'utilisateur (tous workspaces)
    const { error: invoicesError } = await supabase
      .from('invoices')
      .delete()
      .eq('user_id', userId)
    
    if (invoicesError) {
      console.error('‚ùå Erreur suppression factures:', invoicesError)
      return NextResponse.json({ error: 'Erreur lors de la suppression des factures' }, { status: 500 })
    }
    console.log('‚úÖ Factures supprim√©es')

    // 2. Supprimer les jobs d'extraction
    const { error: jobsError } = await supabase
      .from('extraction_jobs')
      .delete()
      .eq('user_id', userId)
    
    if (jobsError) {
      console.error('‚ùå Erreur suppression jobs:', jobsError)
      // Continue m√™me en cas d'erreur (table peut ne pas exister)
    } else {
      console.log('‚úÖ Jobs d\'extraction supprim√©s')
    }

    // 3. Supprimer les comptes email connect√©s
    const { error: emailAccountsError } = await supabase
      .from('email_accounts')
      .delete()
      .eq('user_id', userId)
    
    if (emailAccountsError) {
      console.error('‚ùå Erreur suppression comptes email:', emailAccountsError)
      return NextResponse.json({ error: 'Erreur lors de la suppression des comptes email' }, { status: 500 })
    }
    console.log('‚úÖ Comptes email supprim√©s')

    // 4. R√©cup√©rer les organisations dont l'utilisateur est propri√©taire
    const { data: ownedWorkspaces } = await supabase
      .from('workspaces')
      .select('id')
      .eq('owner_id', userId)

    if (ownedWorkspaces && ownedWorkspaces.length > 0) {
      const workspaceIds = ownedWorkspaces.map(ws => ws.id)

      // 4a. Supprimer les factures de ces organisations
      for (const workspaceId of workspaceIds) {
        await supabase.from('invoices').delete().eq('workspace_id', workspaceId)
      }

      // 4b. Supprimer les comptes email de ces organisations
      for (const workspaceId of workspaceIds) {
        await supabase.from('email_accounts').delete().eq('workspace_id', workspaceId)
      }

      // 4c. Supprimer les membres des organisations
      for (const workspaceId of workspaceIds) {
        await supabase.from('workspace_members').delete().eq('workspace_id', workspaceId)
      }

      // 4d. Supprimer les invitations
      for (const workspaceId of workspaceIds) {
        await supabase.from('workspace_invites').delete().eq('workspace_id', workspaceId)
      }

      // 4e. Supprimer les organisations elles-m√™mes
      const { error: workspacesError } = await supabase
        .from('workspaces')
        .delete()
        .in('id', workspaceIds)

      if (workspacesError) {
        console.error('‚ùå Erreur suppression organisations:', workspacesError)
      } else {
        console.log(`‚úÖ ${workspaceIds.length} organisation(s) supprim√©e(s)`)
      }
    }

    // 5. Supprimer l'utilisateur des organisations o√π il est membre (mais pas propri√©taire)
    const { error: membersError } = await supabase
      .from('workspace_members')
      .delete()
      .eq('user_id', userId)
    
    if (membersError) {
      console.error('‚ùå Erreur suppression membres:', membersError)
    } else {
      console.log('‚úÖ Membres supprim√©s')
    }

    // 6. Supprimer le profil utilisateur (si la table existe)
    const { error: profileError } = await supabase
      .from('profiles')
      .delete()
      .eq('id', userId)
    
    if (profileError) {
      console.error('‚ö†Ô∏è Erreur suppression profil (table peut ne pas exister):', profileError)
    } else {
      console.log('‚úÖ Profil supprim√©')
    }

    // 7. Supprimer l'utilisateur dans auth.users via Admin API
    try {
      const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL || ''
      const supabaseServiceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY || ''
      
      if (supabaseServiceRoleKey && supabaseUrl) {
        const supabaseAdmin = createAdminClient(supabaseUrl, supabaseServiceRoleKey, {
          auth: {
            autoRefreshToken: false,
            persistSession: false
          }
        })
        
        const { error: deleteUserError } = await supabaseAdmin.auth.admin.deleteUser(userId)
        
        if (deleteUserError) {
          console.error('‚ö†Ô∏è Impossible de supprimer auth.users directement:', deleteUserError)
          console.log('‚ÑπÔ∏è Les donn√©es sont supprim√©es, mais l\'utilisateur auth peut n√©cessiter une suppression manuelle')
        } else {
          console.log('‚úÖ Utilisateur auth supprim√©')
        }
      } else {
        console.log('‚ö†Ô∏è SUPABASE_SERVICE_ROLE_KEY non configur√© - l\'utilisateur auth sera supprim√© via triggers CASCADE si configur√©s')
      }
    } catch (adminError: any) {
      console.error('‚ö†Ô∏è Erreur lors de la suppression admin:', adminError)
      console.log('‚ÑπÔ∏è Les donn√©es sont supprim√©es, mais l\'utilisateur auth peut n√©cessiter une suppression manuelle')
    }

    console.log(`‚úÖ Suppression compl√®te termin√©e pour l'utilisateur ${userId}`)

    return NextResponse.json({ 
      success: true, 
      message: 'Compte et toutes les donn√©es associ√©es supprim√©s avec succ√®s' 
    })

  } catch (error: any) {
    console.error('‚ùå Erreur globale lors de la suppression:', error)
    return NextResponse.json({ 
      error: error.message || 'Erreur lors de la suppression du compte' 
    }, { status: 500 })
  }
}

