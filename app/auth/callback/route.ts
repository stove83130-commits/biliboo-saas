import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export const dynamic = 'force-dynamic'

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url)
  const code = requestUrl.searchParams.get('code')
  const plan = requestUrl.searchParams.get('plan')
  const origin = requestUrl.origin

  if (code) {
    const supabase = createClient()
    
    // √âchanger le code contre une session
    const { error } = await supabase.auth.exchangeCodeForSession(code)
    
    if (error) {
      console.error('Erreur lors de l\'√©change du code:', error)
      return NextResponse.redirect(`${origin}/auth/login?error=auth_failed`)
    }

    console.log('‚úÖ Session cr√©√©e avec succ√®s apr√®s OAuth')
  }

  // Si un plan a √©t√© s√©lectionn√©, rediriger vers une page interm√©diaire qui g√©rera le paiement
  if (plan) {
    console.log(`üîÑ Redirection vers plan-redirect avec plan: ${plan}`)
    return NextResponse.redirect(`${origin}/auth/plan-redirect?plan=${plan}`)
  }

  // V√©rifier si c'est un nouvel utilisateur (OAuth) pour rediriger vers l'onboarding
  const supabaseAfterAuth = createClient()
  const { data: { user } } = await supabaseAfterAuth.auth.getUser()
  
  console.log('üîç User apr√®s OAuth:', {
    userId: user?.id,
    email: user?.email,
    metadata: user?.user_metadata,
    identities: user?.identities
  })
  
  // Si c'est un nouvel utilisateur OAuth (pas d'onboarding d√©fini ou false), rediriger vers l'onboarding
  // Par d√©faut, tous les nouveaux utilisateurs OAuth n'ont pas onboarding_completed
  const isNewOAuthUser = user && !user.user_metadata?.onboarding_completed
  const redirectPath = isNewOAuthUser ? '/onboarding' : '/dashboard'
  
  console.log(`üîÑ Redirection vers ${redirectPath} (nouveau OAuth: ${isNewOAuthUser})`)
  const redirectUrl = `${origin}${redirectPath}`
  
  // Forcer la redirection avec status 302 (Found)
  return NextResponse.redirect(redirectUrl, { 
    status: 302,
    headers: {
      'Cache-Control': 'no-store, no-cache, must-revalidate',
    }
  })
}

