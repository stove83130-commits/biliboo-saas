import { createClient } from '@/lib/supabase/server'
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export const dynamic = 'force-dynamic'

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url)
  const code = requestUrl.searchParams.get('code')
  const plan = requestUrl.searchParams.get('plan')
  const origin = requestUrl.origin

  if (code) {
    const supabase = createClient()
    
    // √âchanger le code contre une session
    const { error } = await supabase.auth.exchangeCodeForSession(code)
    
    if (error) {
      console.error('Erreur lors de l\'√©change du code:', error)
      return NextResponse.redirect(`${origin}/auth/login?error=auth_failed`)
    }

    console.log('‚úÖ Session cr√©√©e avec succ√®s apr√®s OAuth')
  }

  // Si un plan a √©t√© s√©lectionn√©, rediriger vers une page interm√©diaire qui g√©rera le paiement
  if (plan) {
    console.log(`üîÑ Redirection vers plan-redirect avec plan: ${plan}`)
    return NextResponse.redirect(`${origin}/auth/plan-redirect?plan=${plan}`)
  }

  // Rediriger vers le dashboard apr√®s une connexion r√©ussie
  console.log('üîÑ Redirection vers le dashboard')
  const redirectUrl = `${origin}/dashboard`
  
  // Forcer la redirection avec status 302 (Found)
  return NextResponse.redirect(redirectUrl, { 
    status: 302,
    headers: {
      'Cache-Control': 'no-store, no-cache, must-revalidate',
    }
  })
}

